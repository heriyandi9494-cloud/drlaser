<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jadwal DR Laser - Rekap Mingguan</title>
<style>
body{font-family:Arial,sans-serif;background:#b0cdeb;padding:10px;}
h1{font-size:18px;margin-bottom:10px;}
button{margin:2px;padding:5px 10px;background:#121212;color:white;border:none;border-radius:5px;cursor:pointer;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #e80505;padding:5px;text-align:center;font-size:12px;}
th{background:#0c25e0;color:white;}
select,input{width:100%;font-size:12px;padding:3px;border-radius:5px;border:1px solid #ccc;}
.ket-ğƒğ¢ğ©ğšğ¤ğšğ¢-15{background:#f6de05;color:#000;}
.ket-ğƒğ¢ğ©ğšğ¤ğšğ¢-30{background:#FF9800;color:#fff;}
.ket-ğƒğ¢ğ©ğšğ¤ğšğ¢-45{background:#8BC34A;color:#fff;}
.ket-ğƒğ¢ğ©ğšğ¤ğšğ¢-60{background:#06eb11;color:#fff;}
.ket-ğ“ğ¢ğğšğ¤{background:#f40515;color:#000;}
.bar-wrap{width:100%;height:15px;background:#eee;border-radius:7px;position:relative;}
.bar{height:100%;width:0%;transition:width 0.5s;}
.bar-text{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:10px;color:rgb(233, 12, 12);font-weight:bold;text-shadow:0 1px 2px rgba(0,0,0,0.3);}
.daily-wrap{margin-top:5px;margin-bottom:15px;}
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<h1>ğ‰ğ€ğƒğ–ğ€ğ‹ ğğ„ğğ†ğ†ğ”ğğ€ğ€ğ ğƒğ‘.ğ‹ğ€ğ’ğ„ğ‘ ğ‡ğ„ğ‘ğˆ</h1>
<button id="addRow">+ ğ“ğšğ¦ğ›ğšğ¡ ğğšğ«ğ¢ğ¬</button>
<button id="exportCSV">ğ„ğ±ğ©ğ¨ğ«ğ­ ğ‚ğ’ğ•</button>
<button id="exportPDF">ğ„ğ±ğ©ğ¨ğ«ğ­ ğğƒğ…</button>

<table id="mainTable">
  <thead>
    <tr>
      <th>ğğ</th>
      <th>ğ‡ğ€ğ‘ğˆ</th>
      <th>ğ“ğ€ğğ†ğ†ğ€ğ‹</th>
      <th>ğŠğ„ğ“ğ„ğ‘ğ€ğğ†ğ€ğ</th>
      <th>ğƒğ”ğ‘ğ€ğ’ğˆ</th>
      <th>ğğ€ğ†ğˆ</th>
      <th>ğŒğ€ğ‹ğ€ğŒ</th>
      <th>ğğ€ğ‘ (%)</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<div class="daily-wrap">
  <strong>ğ“ğ¨ğ­ğšğ¥ ğğğ«ğ¬ğğ§ğ­ğšğ¬ğ ğ‡ğšğ«ğ¢ğšğ§:</strong> <span id="dailyPercent">0%</span>
  <div class="bar-wrap"><div class="bar" id="dailyBar"></div></div>
</div>

<div class="weekly-wrap">
  <strong>ğ‘ğğ¤ğšğ© ğŒğ¢ğ§ğ ğ ğ®ğšğ§:</strong> <span id="weeklyPercent">0%</span>
  <div class="bar-wrap"><div class="bar" id="weeklyBar"></div></div>
</div>

<script>
// ===== Firebase Config =====
const firebaseConfig = {
  apiKey: "AIzaSyCHnFBBhKUg9I0f84ai8_X7kcuQjqgSK5w",
  authDomain: "loginaksi.firebaseapp.com",
  databaseURL: "https://loginaksi-default-rtdb.firebaseio.com",
  projectId: "loginaksi",
  storageBucket: "loginaksi.firebasestorage.app",
  messagingSenderId: "720249983474",
  appId: "1:720249983474:web:7ac6ea27667bea13699b6b",
  measurementId: "G-HRPFQC11P9"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// ===== GLOBAL =====
const hariOptions = ['ğ’ğğ§ğ¢ğ§','ğ’ğğ¥ğšğ¬ğš','ğ‘ğšğ›ğ®','ğŠğšğ¦ğ¢ğ¬','ğ‰ğ®ğ¦ğšğ­','ğ’ğšğ›ğ­ğ®','ğŒğ¢ğ§ğ ğ ğ®'];
const hariColors = {
  'ğ’ğğ§ğ¢ğ§':'#FFEB3B','ğ’ğğ¥ğšğ¬ğš':'#FF9800','ğ‘ğšğ›ğ®':'#8BC34A','ğŠğšğ¦ğ¢ğ¬':'#4CAF50',
  'ğ‰ğ®ğ¦ğšğ­':'#2196F3','ğ’ğšğ›ğ­ğ®':'#9C27B0','ğŒğ¢ğ§ğ ğ ğ®':'#F44336'
};
let data = [];

// ===== RENDER TABLE =====
function renderTable(){
  const tbody=document.getElementById('tableBody');
  tbody.innerHTML='';
  data.forEach((row,idx)=>{
    const tr=document.createElement('tr');
    let hariSelect='<select class="hari">';
    hariOptions.forEach(h=>hariSelect+=`<option value="${h}" ${row.hari===h?'selected':''}>${h}</option>`);
    hariSelect+='</select>';

    tr.innerHTML=`
      <td>${idx+1}</td>
      <td>${hariSelect}</td>
      <td><input type="date" class="tanggal" value="${row.tanggal||''}"></td>
      <td><select class="ket"><option value="ğƒğ¢ğ©ğšğ¤ğšğ¢">ğƒğ¢ğ©ğšğ¤ğšğ¢</option><option value="ğ“ğ¢ğğšğ¤">ğ“ğ¢ğğšğ¤</option></select></td>
      <td><select class="durasi"><option>15</option><option>30</option><option>45</option><option>60</option></select></td>
      <td><select class="pagi"><option value="ğƒğ¢ğ©ğšğ¤ğšğ¢">ğƒğ¢ğ©ğšğ¤ğšğ¢</option><option value="ğ“ğ¢ğğšğ¤">ğ“ğ¢ğğšğ¤</option></select></td>
      <td><select class="malam"><option value="ğƒğ¢ğ©ğšğ¤ğšğ¢">ğƒğ¢ğ©ğšğ¤ğšğ¢</option><option value="ğ“ğ¢ğğšğ¤">ğ“ğ¢ğğšğ¤</option></select></td>
      <td><div class="bar-wrap"><div class="bar"><div class="bar-text">0%</div></div></div></td>
    `;
    tbody.appendChild(tr);

    // Set values
    tr.querySelector('.ket').value=row.ket||'ğƒğ¢ğ©ğšğ¤ğšğ¢';
    tr.querySelector('.durasi').value=row.durasi||'15';
    tr.querySelector('.pagi').value=row.pagi||'ğ“ğ¢ğğšğ¤';
    tr.querySelector('.malam').value=row.malam||'ğ“ğ¢ğğšğ¤';

    updateColor(tr); updateBar(tr); updateHariColor(tr);

    tr.querySelectorAll('input,select').forEach(el=>{
      el.addEventListener('change',()=>updateRow(tr,idx));
      el.addEventListener('input',()=>updateRow(tr,idx));
    });
  });
  updateDailyBar(); updateWeeklyBar();
}

// ===== BAR FUNCTION =====
function updateBar(tr){
  const dur=Number(tr.querySelector('.durasi').value);
  const pagi=tr.querySelector('.pagi').value==='ğƒğ¢ğ©ğšğ¤ğšğ¢'?1:0;
  const malam=tr.querySelector('.malam').value==='ğƒğ¢ğ©ğšğ¤ğšğ¢'?1:0;
  const sessions=pagi+malam;
  const barEl=tr.querySelector('.bar');
  const barText=tr.querySelector('.bar-text');
  if(sessions===0 || dur===0){barEl.style.width='0%'; barText.textContent='0%'; barEl.style.background='#ccc'; return;}
  let persen=Math.min(100,(dur/60)*100*sessions);
  barEl.style.width=persen+'%';
  barText.textContent=Math.round(persen)+'%';
  let color='';
  if(dur==15) color='#FFEB3B';
  else if(dur==30) color='#FF9800';
  else if(dur==45) color='#8BC34A';
  else if(dur==60) color='#2E7D32';
  barEl.style.background = tr.querySelector('.ket').value==='ğƒğ¢ğ©ğšğ¤ğšğ¢'?color:'#ccc';
}

function updateColor(tr){
  const select=tr.querySelector('.ket');
  select.className='ket';
  if(select.value==='ğ“ğ¢ğğšğ¤') select.classList.add('ket-ğ“ğ¢ğğšğ¤');
  else{
    const dur=tr.querySelector('.durasi').value;
    select.classList.add(`ket-ğƒğ¢ğ©ğšğ¤ğšğ¢-${dur}`);
  }
}

function updateHariColor(tr){
  const select=tr.querySelector('.hari');
  select.style.background=hariColors[select.value]||'#fff';
  select.style.color='#fff';
}

// ===== UPDATE DATA =====
function updateRow(tr,idx){
  data[idx]={
    hari: tr.querySelector('.hari').value,
    tanggal: tr.querySelector('.tanggal').value,
    ket: tr.querySelector('.ket').value,
    durasi: tr.querySelector('.durasi').value,
    pagi: tr.querySelector('.pagi').value,
    malam: tr.querySelector('.malam').value
  };
  database.ref('jadwalDRLaser').set(data).then(()=>console.log('Data tersimpan'));
  updateColor(tr); updateBar(tr); updateHariColor(tr); updateDailyBar(); updateWeeklyBar();
}

// ===== DAILY BAR =====
function updateDailyBar(){
  let total=0;
  data.forEach(row=>{
    const dur=Number(row.durasi);
    const s=(row.pagi==='ğƒğ¢ğ©ğšğ¤ğšğ¢'?1:0)+(row.malam==='ğƒğ¢ğ©ğšğ¤ğšğ¢'?1:0);
    total+=Math.min(100,(dur/60)*100*s);
  });
  const avg=data.length?Math.round(total/data.length):0;
  document.getElementById('dailyPercent').innerText=avg+'%';
  document.getElementById('dailyBar').style.width=avg+'%';
}

// ===== WEEKLY BAR =====
function updateWeeklyBar(){
  let total=0;
  data.forEach(row=>{
    const dur=Number(row.durasi);
    const s=(row.pagi==='ğƒğ¢ğ©ğšğ¤ğšğ¢'?1:0)+(row.malam==='ğƒğ¢ğ©ğšğ¤ğšğ¢'?1:0);
    total+=Math.min(100,(dur/60)*100*s);
  });
  const avg=data.length?Math.round(total/data.length):0;
  document.getElementById('weeklyPercent').innerText=avg+'%';
  document.getElementById('weeklyBar').style.width=avg+'%';
}

// ===== BUTTONS =====
document.getElementById('addRow').addEventListener('click',()=>{
  data.push({hari:'Senin',tanggal:'',ket:'ğƒğ¢ğ©ğšğ¤ğšğ¢',durasi:'15',pagi:'ğ“ğ¢ğğšğ¤',malam:'ğ“ğ¢ğğšğ¤'});
  database.ref('jadwalDRLaser').set(data); renderTable();
});

document.getElementById('exportCSV').addEventListener('click',()=>{
  if(!data.length) return;
  let csv='No,Hari,Tanggal,Keterangan,Durasi,Pagi,Malam,Persen\n';
  data.forEach((r,i)=>{
    const s=(r.pagi==='ğƒğ¢ğ©ğšğ¤ğšğ¢'?1:0)+(r.malam==='ğƒğ¢ğ©ğšğ¤ğšğ¢'?1:0);
    let persen=Math.min(100,(Number(r.durasi)/60)*100*s);
    csv+=`${i+1},"${r.hari}","${r.tanggal}","${r.ket}",${r.durasi},${r.pagi},${r.malam},${Math.round(persen)}%\n`;
  });
  const blob=new Blob([csv],{type:'text/csv'});
  const link=document.createElement('a');
  link.href=URL.createObjectURL(blob);
  link.download='drlaser.csv';
  link.click();
});

document.getElementById('exportPDF').addEventListener('click',()=>{
  if(!data.length) return;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(10);
  doc.text("Jadwal DR Laser",14,10);
  let y=20;
  data.forEach((r,i)=>{
    const s=(r.pagi==='ğƒğ¢ğ©ğšğ¤ğšğ¢'?1:0)+(r.malam==='ğƒğ¢ğ©ğšğ¤ğšğ¢'?1:0);
    let persen=Math.min(100,(Number(r.durasi)/60)*100*s);
    doc.text(`${i+1}. ${r.hari} | ${r.tanggal} | ${r.ket} | ${r.durasi} | ${r.pagi} | ${r.malam} | ${Math.round(persen)}%`,14,y);
    y+=6;
    if(y>280){doc.addPage();y=20;}
  });
  doc.save('drlaser.pdf');
});

// ===== LOAD DATA =====
database.ref('jadwalDRLaser').once('value').then(snapshot=>{
  if(snapshot.exists()) data=snapshot.val();
  renderTable();
});
</script>
</body>
</html>
